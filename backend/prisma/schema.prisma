// Zero-Knowledge Billing - Le serveur ne stocke que :
// - Comptes : nom, prénom, adresse, identifiant de connexion, hash du mot de passe
// - Registre de preuves : invoiceId, hash, signature, timestamp (aucun contenu de facture)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  WITNESS   // témoin : valide les sessions
  ADMIN
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  passwordHash   String          @map("password_hash")
  role           Role            @default(USER)
  nom            String
  prenom         String
  adresse        String?
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")

  proofs         Proof[]
  documentProofs DocumentProof[]
}

model Proof {
  id          String   @id @default(cuid())
  invoiceId   String   @unique @map("invoice_id")
  userId      String   @map("user_id")
  invoiceHash String   @map("invoice_hash")
  signature   String
  signedAt    DateTime @map("signed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([invoiceId])
}

model DocumentProof {
  id          String   @id @default(cuid())
  documentId  String   @unique @map("document_id")
  userId      String   @map("user_id")
  fileHash    String   @map("file_hash")
  filename    String
  mimeType    String   @map("mime_type")
  size        Int
  uploadedAt  DateTime @map("uploaded_at")
  invoiceId   String?  @map("invoice_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([documentId])
  @@index([invoiceId])
}
